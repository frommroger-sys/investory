name: Investory Daily Report

on:
  schedule:
    # 06:00 Europe/Zurich ~ 04:00 UTC (Sommerzeit). GitHub CRON läuft in UTC.
    - cron: "0 4 * * 1-5"
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest

    # Secrets stehen allen Steps zur Verfügung
    env:
      INV_WP_BASE:           ${{ secrets.INV_WP_BASE }}
      INV_WP_USER:           ${{ secrets.INV_WP_USER }}
      INV_WP_APP_PW:         ${{ secrets.INV_WP_APP_PW }}
      INV_LOGO_URL:          ${{ secrets.INV_LOGO_URL }}
      INV_POPPINS_REG_URL:   ${{ secrets.INV_POPPINS_REG_URL }}
      INV_POPPINS_BOLD_URL:  ${{ secrets.INV_POPPINS_BOLD_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        run: |
          pwd
          ls -la
          echo "Python file exists?"; test -f daily_report.py && echo "YES" || (echo "NO"; exit 1)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests reportlab

      - name: Generate & upload PDF
        run: |
          python - <<'PY'
          import traceback
          try:
              import daily_report
              report_data = {
                  "headline": ["Testlauf – PDF sollte in WP erscheinen"],
                  "regions": {}
              }
              url = daily_report.run_pdf_pipeline(report_data)
              print("RESULT_URL:", url)
          except Exception as e:
              print("ERROR:", e)
              traceback.print_exc()
              raise
          PY
